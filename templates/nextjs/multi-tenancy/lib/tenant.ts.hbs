import { prisma } from "@/lib/prisma";
import { headers } from "next/headers";
import { cache } from "react";

export interface TenantContext {
  tenantId: string;
  tenantSlug: string;
  tenantName: string;
}

/**
 * Resolve the current tenant from the request.
 * Cached per-request using React cache.
 */
export const getCurrentTenant = cache(async (): Promise<TenantContext | null> => {
  const headersList = await headers();
{{#if isSubdomain}}
  const host = headersList.get("host") || "";
  const subdomain = host.split(".")[0];
  if (!subdomain || subdomain === "www" || subdomain === "app") return null;

  const tenant = await prisma.tenant.findUnique({
    where: { slug: subdomain },
  });
{{else}}
  const tenantSlug = headersList.get("x-tenant-slug");
  if (!tenantSlug) return null;

  const tenant = await prisma.tenant.findUnique({
    where: { slug: tenantSlug },
  });
{{/if}}

  if (!tenant) return null;

  return {
    tenantId: tenant.id,
    tenantSlug: tenant.slug,
    tenantName: tenant.name,
  };
});

/**
 * Require tenant context. Throws if not in a tenant context.
 */
export async function requireTenant(): Promise<TenantContext> {
  const tenant = await getCurrentTenant();
  if (!tenant) {
    throw new Error("Tenant context required");
  }
  return tenant;
}
